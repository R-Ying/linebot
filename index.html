<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LIFF</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.js"></script>
    <style>
      #MainDiv label {
        margin: 3px;
      }
      #MainDiv textarea {
        margin: 3px;
      }
      #uploadInput {
        margin: 3px;
      }
      #imagePreview {
        margin: 3px;
      }
    </style>
    <script>
      const LiffAppId = "2000183206-NjVg83LK";

      function initializeLiff(myLiffId) {
        liff
          .init({
            liffId: myLiffId,
          })
          .then(() => {
            if (!liff.isLoggedIn()) {
              // 用戶未登入，引導用戶登入
              liff.login();
            } else {
              // 用户已登入，獲取用戶資訊
              liff.getProfile().then(function (profile) {
                $("#field_info").val(profile.userId);
              });
            }
          })
          .catch((err) => {
            console.log(err.code, err.message);
          });
      }
      $(document).ready(function () {
        initializeLiff(LiffAppId);
      });
    </script>
    <script src="https://unpkg.com/vconsole"></script>
    <script>
      const vConsole = new VConsole();
    </script>
  </head>
  <body>
    <div class="row">
      <div id="MainDiv" class="col-md-6" style="margin: 5px">
        <label>info:</label>
        <textarea
          class="form-control"
          rows="3"
          type="text"
          id="field_info"
        ></textarea>
        <hr />
      </div>
    </div>
    <!--Web無法直接建立File物件，透過從<input>元素中選擇的檔案於FileList物件中取得-->
    <input id="uploadInput" type="file" accept="image/*" />
    <div id="imagePreview"></div>
    <script>
      const input = document.getElementById("uploadInput");
      //監聽change事件中的event.target.files可取得FileList物件，裡面含有File物件
      input.addEventListener("change", async (event) => {
        if (!liff.isLoggedIn()) {
          liff.login();
          return; // 直接返回，不執行後續程式
        }
        const data = new FormData();
        const file = event.target.files[0]; //取得filelist物件
        if (file && file.type.match("image.*")) {
          data.append("image_file", file, "image_file");
          //讀取和顯示圖片預覽
          const reader = new FileReader();
          reader.onload = function (e) {
            document.getElementById(
              "imagePreview"
            ).innerHTML = `<img src="${e.target.result}" style="max-width: 200px;">`;
          };
          reader.readAsDataURL(file);

          //處理EXIF數據
          EXIF.getData(file, async function () {
            const location = getLocation(this);

            data.append(
              "latitude",
              location.latitude ? location.latitude.toString() : ""
            );
            data.append(
              "longitude",
              location.longitude ? location.longitude.toString() : ""
            );

            const profile = await liff.getProfile();
            const userId = profile.userId;
            data.append("userId", userId); //添加userId到FormData

            const response = await fetch("/detect", {
              method: "post", //指定請求的方法為POST，因為要向服務器發送數據
              body: data, //在body中發送一個FormData對象，這裡的data是一個FormData實例
            });
            const result = await response.json();

            if (result.message === "Success") {
              await fetch("/api/save-upload-info", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ userId }),
              });
              alert("圖片上傳成功");
            } else {
              alert(result.detail);
            }
          });
        }
      });
      //將DMS(度分秒)轉換為DD(十進制度)
      function convertDMSToDD(degrees, minutes, seconds, direction) {
        let dd = degrees + minutes / 60 + seconds / (60 * 60);
        if (direction == "S" || direction == "W") {
          dd = dd * -1;
        }
        return dd;
      }
      // 獲取緯度和經度
      function getLocation(imgExif) {
        const lat = EXIF.getTag(imgExif, "GPSLatitude");
        const lon = EXIF.getTag(imgExif, "GPSLongitude");
        const latRef = EXIF.getTag(imgExif, "GPSLatitudeRef");
        const lonRef = EXIF.getTag(imgExif, "GPSLongitudeRef");

        const latitude = lat
          ? convertDMSToDD(lat[0], lat[1], lat[2], latRef)
          : null;
        const longitude = lon
          ? convertDMSToDD(lon[0], lon[1], lon[2], lonRef)
          : null;

        return { latitude, longitude };
      }
    </script>
  </body>
</html>
